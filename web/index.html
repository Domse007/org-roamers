<!DOCTYPE html>
<html style="overflow: hidden;">
  <head>
    <meta charset="UTF-8" />
    <title>org-roam-rs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/2.4.0/sigma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphology/0.25.4/graphology.umd.min.js"></script>
    <!-- KaTeX: LaTeX for the web -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css"
	  integrity="sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js"
	    integrity="sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js"
	    integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
	    onload="renderMathInElement(document.body);"></script>
    <!-- syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
  </head>
  
  <body style="overflow: hidden;">
    <div id="search-wrapper" style="width: 40%; margin: 5px; margin-left: 30%; position: absolute; z-index: 100;">
      <input id="search-input" placeholder="Search for nodes..." type="search" style="width: 100%">
      <div id="search-suggestion-wrapper"></div>
    </div>

    <div id="org-preview-wrapper" style="width: 30%; background-color: lightgray; right: 0px; top: 0px; position: absolute; z-index: 50; resize: horizontal; float: left;">
      <div id="org-preview-dragging-area" style="width: 10px; height: 100vh; float: left; background-color: black; cursor: col-resize"></div>
      <div id="org-preview" style="min-height: 100vh; max-height: 100vh; overflow: scroll; padding: 10px; "></div>
    </div>
    
    <div id="graph" style="display: flex; min-width: 100%; min-height: 100vh;"></div>

    <script>

      const MIN_SIZE = 200;
      const BORDER_SIZE = 10;
      const panel = document.getElementById('org-preview-dragging-area');
      const panel_wrapper = document.getElementById('org-preview-wrapper');

      let m_pos;
      
      function resize(e) {
	  const dx = m_pos - e.x;
	  m_pos = e.x;
	  const new_width = Math.max((parseInt(getComputedStyle(panel_wrapper, '').width) + dx), MIN_SIZE);
	  panel_wrapper.style.width = new_width + "px";
      }
      
      panel.addEventListener("mousedown", function(e){
	  if (e.offsetX < BORDER_SIZE) {
	      m_pos = e.x;
	      document.addEventListener("mousemove", resize, false);
	  }
      }, false);

      document.addEventListener("mouseup", function(){
	  document.removeEventListener("mousemove", resize, false);
      }, false);
      
      const syntaxHighlight = () => {
	  Array.from(document.getElementsByClassName("src"))
	      .forEach((item) => {
		  hljs.highlightElement(item)
	      }); 
      }

      const preview = (name) => {
	  fetch(`/org?title=${name}`)
	      .then((response) => {
		  console.log(response);
		  return response.text();
	      }).then((html) => {
		  console.log(html);
		  document.getElementById('org-preview').innerHTML = html;
		  renderMathInElement(document.getElementById('org-preview'));
		  syntaxHighlight();
	      });	  
      };

      preview("Kreise");
      
      // Create a graphology graph
      const graph = new graphology.Graph();
      graph.addNode("1", { label: "Node 1", x: 0, y: 0, size: 10, color: "blue" });
      graph.addNode("2", { label: "Node 2", x: 1, y: 1, size: 20, color: "red" });
      graph.addEdge("1", "2", { size: 5, color: "purple" });
      
      // Instantiate sigma.js and render the graph
      const sigmaInstance = new Sigma(graph, document.getElementById("graph"));

      const search = async (query) => {
	  const resp = await fetch(`/search?q=${query}`);
	  const text = await resp.json();
	  const res = JSON.parse(text);
	  return res;
      }

      const searchInput = document.getElementById('search-input')
      let searchSuggestion = document.getElementById('search-suggestion-wrapper')
      searchInput.addEventListener("input", (event) => {
	  const query = searchInput.value;
	  searchSuggestion.innerHTML = "";
	  search(query).then((res) => {
	      console.log(res);
	      res["results"].forEach((e) => {
		  console.log("Updateing");
		  searchSuggestion.innerHTML += `<div onclick="preview('${e.title}')" style="background-color: gray;">${e.title}</div>`;
	      })
	  })
      });
    </script>
  </body>
</html> 
